<%- include('./partials/header') %>

<div class="text-white mb-4 text-center">
  <h1 class="fw-bold mb-2">Biểu đồ</h1>
  <p class="mb-0 text-light opacity-75">Chọn chế độ để xem nhanh các chỉ số chính.</p>
</div>

<div class="card border-0 shadow-lg rounded-4 mb-4 bg-light">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 mb-3">
      <button class="btn btn-outline-primary btn-sm" data-chart="users">Đăng ký người dùng</button>
      <button class="btn btn-outline-success btn-sm" data-chart="recipes">Bài đăng theo ngày</button>
      <button class="btn btn-outline-danger btn-sm" data-chart="status">Bài đăng theo trạng thái</button>
    </div>
    <div class="position-relative bg-white rounded-3 p-3 border">
      <canvas id="analyticsChart" height="180"></canvas>
      <div id="chartEmpty" class="text-center text-muted py-4 d-none">
        Chưa có dữ liệu để vẽ biểu đồ.
      </div>
    </div>
    <p class="small text-muted mt-3 mb-0">
      Gợi ý: dùng “Đăng ký người dùng” để theo dõi tăng trưởng, “Bài đăng theo trạng thái” để xem tải kiểm duyệt.
    </p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  const usersData = <%- JSON.stringify(dataUsers || []) %>;
  const recipesData = <%- JSON.stringify(dataRecipes || []) %>;
  const statusData = <%- JSON.stringify(dataStatus || []) %>;

  const ctx = document.getElementById('analyticsChart').getContext('2d');
  let chart;

  const ensureSeries = (arr, days = 7) => {
    if (arr && arr.length) return arr;
    const today = new Date();
    const pad = [];
    for (let i = days - 1; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      pad.push({ day: d.toISOString().slice(0, 10), count: 0 });
    }
    return pad;
  };

  const buildDataset = (type) => {
    if (type === 'users') {
      const series = ensureSeries(usersData, 7);
      return {
        type: 'line',
        labels: series.map(d => d.day),
        data: series.map(d => d.count),
        label: 'Đăng ký mới',
        bg: 'rgba(59,130,246,0.25)',
        border: '#3b82f6'
      };
    }
    if (type === 'recipes') {
      const series = ensureSeries(recipesData, 7);
      return {
        type: 'bar',
        labels: series.map(d => d.day),
        data: series.map(d => d.count),
        label: 'Bài đăng theo ngày',
        bg: 'rgba(34,197,94,0.35)',
        border: '#22c55e'
      };
    }
    return {
      type: 'doughnut',
      labels: (statusData && statusData.length ? statusData : [{ status: 'Không có', count: 0 }]).map(d => d.status || 'khác'),
      data: (statusData && statusData.length ? statusData : [{ count: 0 }]).map(d => d.count),
      label: 'Trạng thái bài',
      bgArray: ['#f97316', '#22c55e', '#eab308', '#ef4444', '#6366f1'],
    };
  };

  const renderChart = (type) => {
    const ds = buildDataset(type);
    if (chart) chart.destroy();

    const emptyDiv = document.getElementById('chartEmpty');
    const noData =
      (type === 'status' && (!statusData || !statusData.length)) ||
      (type !== 'status' && ds.data.every((v) => !v));
    emptyDiv.classList.toggle('d-none', !noData);

    if (type === 'status') {
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ds.labels,
          datasets: [{ data: ds.data, backgroundColor: ds.bgArray }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
      return;
    }
    chart = new Chart(ctx, {
      type: ds.type,
      data: {
        labels: ds.labels,
        datasets: [
          {
            label: ds.label,
            data: ds.data,
            backgroundColor: ds.bg,
            borderColor: ds.border,
            borderWidth: 2,
            tension: 0.3,
            fill: ds.type === 'line',
          }
        ]
      },
      options: {
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
        plugins: { legend: { display: true } }
      }
    });
  };

  document.querySelectorAll('[data-chart]').forEach(btn => {
    btn.addEventListener('click', () => renderChart(btn.dataset.chart));
  });

  renderChart('users');
</script>

<%- include('./partials/footer') %>
