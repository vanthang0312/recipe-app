<%- include('partials/header') %>

<div class="container py-5 min-vh-100">
  <!-- Hero Section -->
  <div class="text-center mb-5 pt-5">
    <h1 class="display-3 fw-bold mb-3 hero-title hero-title-accent">
      Công thức nấu ăn Việt Nam
    </h1>
    <p class="lead fs-3 text-muted opacity-90">
      Hàng ngàn món ngon từ mọi miền đất nước được cộng đồng chia sẻ
    </p>
    <div class="mt-4">
      <i class="fas fa-pepper-hot text-danger fs-1"></i>
      <i class="fas fa-drumstick-bite text-danger fs-1 mx-4"></i>
      <i class="fas fa-bread-slice text-danger fs-1"></i>
    </div>
  </div>

  <!-- Tìm kiếm + Thêm món -->
  <div class="row justify-content-center align-items-center mb-5 g-4">
    <div class="col-lg-7">
      <form
        action="/"
        method="GET"
        class="d-flex flex-column flex-sm-row gap-3"
      >
        <input
          type="text"
          name="search"
          class="form-control form-control-lg rounded-pill shadow-sm border-0 flex-fill home-search-input"
          placeholder="Tìm món ăn..."
          value="<%= search || '' %>"
          aria-label="Tìm kiếm công thức"
        />
        <button
          class="btn btn-danger btn-lg rounded-pill px-5 shadow-lg flex-shrink-0"
        >
          <i class="fas fa-search me-2"></i> Tìm
        </button>
      </form>
    </div>
    <% if (user) { %>
    <div class="col-lg-4 text-center text-lg-end">
      <a
        href="/recipes/add"
        class="btn btn-success btn-lg rounded-pill px-5 shadow-lg"
      >
        <i class="fas fa-plus-circle me-2"></i> Thêm món mới
      </a>
    </div>
    <% } %>
  </div>

  <!-- Nội dung -->
  <% if (recipes.length === 0) { %>
  <div class="text-center py-5 my-5">
    <img
      src="https://i.imgur.com/8QdZ4Zm.png"
      alt="Chưa có món ăn"
      width="180"
      class="mb-4 opacity-50"
    />
    <h3 class="text-muted fw-light mb-3">
      <% if (search) { %> Không tìm thấy món nào phù hợp với "<%= search %>" <% } else { %>
      Chưa có công thức nào <% } %>
    </h3>
    <p class="text-muted lead mb-4">
      <% if (search) { %> Hãy thử tìm với từ khóa khác nhé! <% } else { %> Hãy là người
      đầu tiên chia sẻ món ăn yêu thích của bạn! <% } %>
    </p>
    <% if (user) { %>
    <a
      href="/recipes/add"
      class="btn btn-success btn-lg rounded-pill px-5 shadow"
    >
      <i class="fas fa-plus me-2"></i> Đăng món đầu tiên
    </a>
    <% } else { %>
    <a href="/register" class="btn btn-outline-danger btn-lg rounded-pill px-5">
      <i class="fas fa-user-plus me-2"></i> Đăng ký để chia sẻ
    </a>
    <% } %>
  </div>
  <% } else { %>
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 row-cols-xl-4 g-5 mb-5">
    <% recipes.forEach(recipe => { %>
    <div class="col">
      <div
        class="recipe-card h-100 d-flex flex-column position-relative overflow-hidden rounded-4 shadow-lg transition-all"
      >
        <div class="position-relative overflow-hidden">
          <% const imageUrl = recipe.image ? (recipe.image.startsWith('http') ?
          recipe.image : '/' + recipe.image.replace(/^\/+/, '')) :
          `https://source.unsplash.com/600x400/?vietnamese-food,${encodeURIComponent(recipe.title)},dish`;
          %>
          <img
            src="<%= imageUrl %>"
            alt="<%= recipe.title %>"
            class="card-img-top recipe-card-img"
            onerror="this.src='https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-4.0.3&auto=format&fit=crop&q=80'"
          />
          <% if (recipe.avgRating && Number(recipe.avgRating) >= 4) { %>
          <div class="position-absolute top-0 end-0 p-3">
            <span class="badge bg-danger fs-6 shadow">
              <i class="fas fa-fire me-1"></i>Nổi bật
            </span>
          </div>
          <% } %>
        </div>
        <div class="recipe-card__body recipe-card__body--white card-body p-4 d-flex flex-column">
          <h5 class="card-title fw-bold text-danger fs-4 mb-2 line-clamp-2">
            <%= recipe.title %>
          </h5>
          <p class="text-muted small mb-3">
            <i class="fas fa-user-circle text-danger me-1"></i> bởi
            <strong><%= recipe.username || 'Ẩn danh' %></strong>
          </p>
          <% if (recipe.description) { %>
          <p class="text-secondary flex-grow-1 line-clamp-3 mb-3">
            <%= recipe.description %>
          </p>
          <% } %>
          <div class="recipe-card__cta mt-auto pt-2">
            <a
              href="/recipes/<%= recipe.id %>"
              class="btn btn-danger w-100 rounded-pill fw-bold shadow-sm py-3"
              ><i class="fas fa-book-open me-2"></i> Xem công thức</a
            >
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
  <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
  <nav aria-label="Phân trang công thức" class="d-flex justify-content-center">
    <ul class="pagination pagination-lg">
      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
        <a
          class="page-link rounded-pill mx-1"
          href="?page=<%= currentPage - 1 %>&search=<%= encodeURIComponent(search || '') %>"
          tabindex="-1"
          ><i class="fas fa-chevron-left"></i
        ></a>
      </li>
      <% const startPage = Math.max(1, currentPage - 2); const endPage =
      Math.min(totalPages, currentPage + 2); %> <% for(let i = startPage; i <=
      endPage; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a
          class="page-link rounded-pill mx-1 <%= i === currentPage ? 'bg-danger border-danger' : '' %>"
          href="?page=<%= i %>&search=<%= encodeURIComponent(search || '') %>"
          ><%= i %></a
        >
      </li>
      <% } %>
      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
        <a
          class="page-link rounded-pill mx-1"
          href="?page=<%= currentPage + 1 %>&search=<%= encodeURIComponent(search || '') %>"
          ><i class="fas fa-chevron-right"></i
        ></a>
      </li>
    </ul>
  </nav>
  <% } %> <% } %>
</div>

<%- include('partials/footer') %>
